# Hugo 博客部署脚本使用指南

## 概述

`deploy.sh` 是一个增强版的 Hugo 博客部署脚本，包含了多项预检查和验证功能，帮助您在部署前发现和避免常见问题。

## 新增特性

### 🔍 预检查阶段（部署前自动执���）

#### 1. 子模块状态检查
- **检查内容**：检测 `themes/PaperMod` 等子模块是否已初始化
- **自动修复**：如果未初始化，自动执行 `git submodule update --init --recursive`
- **避免问题**：防止主题未加载导致页面生成失败

#### 2. 未来日期文章检查
- **检查内容**：扫描 `content/posts/` 目录，查找 `draft: false` 但日期在未来的文章
- **警告提示**：列出所有未来日期的文章，并询问是否继续部署
- **避免问题**：防止文章因未来日期而不被发布

#### 3. 草稿文章统计
- **检查内容**：统计 `draft: true` 的文章数量
- **信息提示**：告知有多少篇草稿不会被发布

### 📊 构建验证阶段

#### 1. 页面数量检查
- **检查内容**：统计生成的页面总数
- **异常警告**：如果页面数 < 50，发出警告并提供可能原因

#### 2. 关键页面验证
- **检查内容**：确保 `public/index.html` 存在
- **避免问题**：防止首页生成失败

#### 3. 最新文章验证
- **检查内容**：检查最新修改的文章是否正确生成
- **警告提示**：如果最新文章未生成，发出警告

### 📈 部署统计

部署完成后显示：
- 总页面数
- 子模块状态
- 博客地址
- 实用提示

## 使用方法

### 基本用法

```bash
./deploy.sh
```

### 执行流程

```
🔍 0. 部署前检查...
   ✅ 子模块状态正常
   ℹ️  发现 0 篇草稿文章（不会被发布）

📦 1. 更新子模块并构建 Hugo 站点...
Start building sites …

🔍 2. 验证构建结果...
   📄 生成页面数: 299
   ✅ 构建验证通过

📝 3. 保存源代码更改...
🚀 4. 推送源代码到 main 分支...
🌐 5. 部署到 gh-pages 分支...

✅ 部署完成！
```

## 常见问题诊断

### 问题1：文章发布后访问404

**可能原因**：
- 文章日期在未来
- 子模块未初始化
- 文件名或frontmatter格式错误

**解决方法**：
1. 检查文章日期：`date: 2026-01-13T12:00:00+08:00`（不能是未来时间）
2. 运行 `git submodule status` 检查子模块
3. 确保 `draft: false`

### 问题2：页面数量异常少（< 50）

**可能原因**：
- 大部分文章日期在未来
- 主题未正确加载
- `draft: true` 的文章太多

**解决方法**：
1. 检查文章日期设置
2. 运行 `git submodule update --init --recursive`
3. 检查 `draft` 设置

### 问题3：子模块未初始化

**症状**：
```
WARN  found no layout file for "html" for kind "home"
```

**解决方法**：
```bash
git submodule update --init --recursive
./deploy.sh
```

脚本会自动检测并修复这个问题。

## 最佳实践

### 1. 设置文章日期

✅ **正确**：
```yaml
---
title: "我的文章"
date: 2026-01-13T12:00:00+08:00  # 当前或过去时间
draft: false
---
```

❌ **错误**：
```yaml
---
title: "我的文章"
date: 2026-01-13T22:00:00+08:00  # 未来时间
draft: false
---
```

### 2. 使用草稿功能

对于未完成的文章：
```yaml
---
draft: true  # 设置为草稿，不会被发布
---
```

完成后改为：
```yaml
---
draft: false
date: 2026-01-13T12:00:00+08:00
---
```

### 3. 定期检查子模块

```bash
git submodule status
```

如果看到 `-` 开头的输出，说明子模块未初始化：
```bash
git submodule update --init --recursive
```

## 技术细节

### 未来日期检测逻辑

脚本使用以下逻辑检测未来日期：

```bash
FILE_DATE=$(date -j -f "%Y-%m-%dT%H:%M:%S%z" "$DATE" +"%s")
NOW=$(date +"%s")
if [ "$FILE_DATE" -gt "$NOW" ]; then
    # 文章日期在未来
fi
```

### 页面数量警告阈值

```bash
if [ "$PAGE_COUNT" -lt 50 ]; then
    # 发出警告
fi
```

这个阈值是根据博客规模调整的。如果您的博客文章少于50篇，可以降低这个阈值。

## 维护建议

### 定期更新脚本

根据遇到的新问题，持续改进脚本的检查功能。

### 自定义配置

修改以下变量以适应您的博客：

```bash
# 页面数量警告阈值（第95行）
if [ "$PAGE_COUNT" -lt 50 ]; then  # 改为您的阈值
```

## 故障排除

### 脚本无法执行

```bash
chmod +x deploy.sh
```

### date 命令错误

macOS 的 `date` 命令不支持 `-j` 选项，脚本会自动处理。如果仍有问题：

```bash
brew install coreutils
```

### 部署中断

如果在部署过程中按 `Ctrl+C` 中断，手动清理：

```bash
git checkout main
git branch -D gh-pages-temp  # 如果存在
```

## 相关文件

- `deploy.sh` - 主部署脚本
- `hugo.yaml` - Hugo 配置文件
- `content/posts/` - 文章目录
- `themes/PaperMod/` - 主题子模块

## 更新日志

### v2.0 (2026-01-13)
- ✅ 添加子模块状态检查
- ✅ 添加未来日期文章检测
- ✅ 添加草稿文章统计
- ✅ 添加构建结果验证
- ✅ 添加页面数量异常警告
- ✅ 添加最新文章验证
- ✅ 添加部署统计信息
- ✅ 改进错误处理和用户提示
- ✅ 添加 `set -e` 确保遇到错误立即退出

### v1.0
- 基础部署功能
- 子模块初始化
- 构建和推送

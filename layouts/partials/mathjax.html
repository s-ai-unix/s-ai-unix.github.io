{{ if or .Params.mathjax .Site.Params.mathjax }}
<script>
// 修复 Goldmark 导致的双重转义问题，然后加载 MathJax
(function() {
  'use strict';

  // 在页面加载前修复双重转义
  function fixDoubleEscapes() {
    var elements = document.querySelectorAll('p, li, td, div, span, h1, h2, h3, h4, h5, h6');
    elements.forEach(function(el) {
      var html = el.innerHTML;
      var fixed = false;

      // 修复下划线问题: $h_<em>t</em>$ -> $h_t$
      if (html.indexOf('<em>') !== -1) {
        var newHtml = html.replace(
          /\$([^$]*?)<em>([^<]+?)<\/em>([^$]*?)\$/g,
          function(match, before, sub, after) {
            if (/^[\d.,]+$/.test((before + sub + after).replace(/[.,]/g, ''))) {
              return match; // 跳过货币
            }
            return '$' + before + '_' + sub + after + '$';
          }
        );
        newHtml = newHtml.replace(
          /\$\$([^$]*?)<em>([^<]+?)<\/em>([^$]*?)\$\$/g,
          function(match, before, sub, after) {
            return '$$' + before + '_' + sub + after + '$$';
          }
        );
        if (newHtml !== html) {
          html = newHtml;
          fixed = true;
        }
      }

      // 修复双重转义: \\ -> \
      // 只在数学公式内修复，避免破坏LaTeX命��
      if (html.indexOf('\\\\') !== -1) {
        // 只在 $...$ 或 $$...$$ 内部替换 \\...\
        var newHtml = html.replace(
          /(\$\{1,2\})([^$]*?)(\$\{1,2\})/g,
          function(match, open, content, close) {
            // 在公式内容中将 \\ 替换为 \
            return open + content.replace(/\\\\(.)/g, function(m, c) {
              return '\\' + c;
            }) + close;
          }
        );
        if (newHtml !== html) {
          html = newHtml;
          fixed = true;
        }
      }

      if (fixed) {
        el.innerHTML = html;
      }
    });
  }

  // 配置 MathJax（在fixDoubleEscapes函数之后定义）
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$']],
      displayMath: [['$$', '$$']],
      processEscapes: true,
      processEnvironments: true,
      tags: 'ams',
      macros: {
        // 定义双重闭合积分符号（使用Unicode字符，包裹在\mathop中以获得正确的大小和字体）
        oiint: '\\mathop{∯}',
        oiiint: '\\mathop{∰}'
      }
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    startup: {
      pageReady: function() {
        // 在渲染前修复公式
        fixDoubleEscapes();
        return MathJax.startup.defaultPageReady().then(function() {
          console.log('MathJax formulas rendered successfully');
        });
      }
    }
  };
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{{ end }}
